{% extends "blog/base.html" %}
{% load static %}

{% block content %}
<div class="container my-5">
    <h2>Create New Post</h2>
    <form id="createPostForm" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="text" name="title" placeholder="Title" class="form-control mb-2" required>
        <textarea name="content" placeholder="Content" class="form-control mb-2" required></textarea>
        <input type="file" name="image" class="form-control mb-2">
        <input type="file" name="video" class="form-control mb-2">
        <input type="text" name="category" placeholder="Category" class="form-control mb-2" required>
        <button type="submit" class="btn btn-primary">Create</button>
    </form>

    <hr>
    <h2>All Posts</h2>
    <table class="table table-bordered" id="postsTable">
        <thead>
            <tr>
                <th>Title</th>
                <th>Category</th>
                <th>Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for post in posts %}
            <tr data-id="{{ post.id }}">
                <td class="title">{{ post.title }}</td>
                <td class="category">{{ post.category }}</td>
                <td class="date">{{ post.created_at|date:"d M Y" }}</td>
                <td>
                    <button class="btn btn-warning btn-sm edit-btn">Edit</button>
                    <button class="btn btn-danger btn-sm delete-btn">Delete</button>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="4">No posts found</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const createForm = document.getElementById("createPostForm");

    // Create Post
    createForm.addEventListener("submit", function(e) {
        e.preventDefault();
        let formData = new FormData(createForm);
        fetch("{% url 'manage_posts' %}", {
            method: "POST",
            headers: { "X-Requested-With": "XMLHttpRequest" },
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                let row = `<tr data-id="${data.id}">
                    <td class="title">${data.title}</td>
                    <td class="category">${data.category}</td>
                    <td class="date">${data.date}</td>
                    <td>
                        <button class="btn btn-warning btn-sm edit-btn">Edit</button>
                        <button class="btn btn-danger btn-sm delete-btn">Delete</button>
                    </td>
                </tr>`;
                document.querySelector("#postsTable tbody").insertAdjacentHTML("afterbegin", row);
                createForm.reset();
            } else {
                alert("Error creating post.");
            }
        });
    });

    // Edit Post Inline
    document.querySelector("#postsTable").addEventListener("click", function(e) {
        if (e.target.classList.contains("edit-btn")) {
            let row = e.target.closest("tr");
            let title = row.querySelector(".title").innerText;
            let category = row.querySelector(".category").innerText;

            row.innerHTML = `<td><input type="text" value="${title}" class="form-control title-input"></td>
                             <td><input type="text" value="${category}" class="form-control category-input"></td>
                             <td>${row.querySelector(".date").innerText}</td>
                             <td>
                                 <button class="btn btn-success btn-sm save-btn">Save</button>
                                 <button class="btn btn-secondary btn-sm cancel-btn">Cancel</button>
                             </td>`;
        }

        // Save Updated Post
        if (e.target.classList.contains("save-btn")) {
            let row = e.target.closest("tr");
            let id = row.dataset.id;
            let formData = new FormData();
            formData.append("title", row.querySelector(".title-input").value);
            formData.append("category", row.querySelector(".category-input").value);
            formData.append("content", "Updated via inline edit");
            fetch(`/update/${id}/`, {
                method: "POST",
                headers: { "X-CSRFToken": "{{ csrf_token }}" },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    row.innerHTML = `<td class="title">${data.title}</td>
                                     <td class="category">${data.category}</td>
                                     <td class="date">${data.date}</td>
                                     <td>
                                         <button class="btn btn-warning btn-sm edit-btn">Edit</button>
                                         <button class="btn btn-danger btn-sm delete-btn">Delete</button>
                                     </td>`;
                }
            });
        }

        // Delete Post
        if (e.target.classList.contains("delete-btn")) {
            if (confirm("Are you sure?")) {
                let row = e.target.closest("tr");
                let id = row.dataset.id;
                fetch(`/delete/${id}/`, {
                    method: "POST",
                    headers: { "X-CSRFToken": "{{ csrf_token }}" }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        row.remove();
                    }
                });
            }
        }

        // Cancel Edit
        if (e.target.classList.contains("cancel-btn")) {
            window.location.reload();
        }
    });
});
</script>
{% endblock %}
